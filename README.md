# Xcards

![coverage][coverage_badge]
[![style: very good analysis][very_good_analysis_badge]][very_good_analysis_link]
[![License: MIT][license_badge]][license_link]

A Flutter application for **spaced repetition learning using flashcards** - created as a certification project for [10xDevs](https://www.10xdevs.pl/).

## About This Project ğŸ“–

**Xcards** is a mobile application designed to help users learn effectively through the spaced repetition technique. The app allows users to create, manage, and study flashcards optimized for long-term memory retention.

### ğŸ“ 10xDevs Certification Project

This project is being developed as part of the 10xDevs certification program, demonstrating proficiency in using AI to deliver apps quicker!

### ğŸ“š Additional Context

For AI agents and developers working on this project:
- **Architecture & Coding Rules**: See `.cursor/rules/` directory for comprehensive guidelines
- **Quick Reference**: `.cursor/rules/README.md` contains key concepts and examples
- **Tech Stack**: Flutter, Dart, BLoC/Cubit, auto_route, get_it, freezed, retrofit, flutter_screenutil
- **Localization**: English (en) and Polish (pl) languages supported

Generated by the [Very Good CLI][very_good_cli_link] ğŸ¤–

---

## Project Architecture ğŸ—ï¸

This project follows **Clean Architecture** principles with strict layer separation:

### Layer Structure

```
lib/
â”œâ”€â”€ app/                    # Application-wide configurations
â”‚   â”œâ”€â”€ config/            # DI, networking, database setup
â”‚   â”œâ”€â”€ constants/         # App-wide constants
â”‚   â””â”€â”€ failures/          # Error handling (AppFailure)
â”œâ”€â”€ presentation/          # Shared UI components
â”‚   â”œâ”€â”€ common_widgets/    # Reusable widgets
â”‚   â”œâ”€â”€ routing/          # Auto Route configuration
â”‚   â””â”€â”€ styles/           # AppDimensions, AppColors, AppTextStyles
â””â”€â”€ features/             # Feature modules
    â””â”€â”€ {feature}/
        â”œâ”€â”€ data/         # DTOs, API clients, services
        â”œâ”€â”€ domain/       # Models, use cases (business logic)
        â””â”€â”€ presentation/ # Cubits, pages, views, widgets
```

### Key Architectural Decisions

- **State Management**: BLoC pattern with Cubit
- **Dependency Injection**: get_it with injectable for automatic registration
- **Navigation**: auto_route for type-safe routing
- **Immutability**: freezed for all data classes
- **Error Handling**: Centralized AppFailure instead of exceptions
- **Responsive Design**: flutter_screenutil with AppDimensions (no magic numbers)
- **Localization**: ARB files with context-based access (no hardcoded strings)

### Development Guidelines

All code should follow the rules defined in `.cursor/rules/`:
- **shared.mdc** - Architecture, tech stack, global patterns
- **page.mdc** - UI layer (Pages, Views, Widgets)
- **cubit.mdc** - State management (Cubits, States)
- **service.mdc** - Data layer (Services, DTOs, API clients)
- **l10n.mdc** - Localization guidelines
- **testing.mdc** - Testing patterns and mocking strategies

---

## Getting Started ğŸš€

This project contains 3 flavors:

- development
- staging
- production

To run the desired flavor either use the launch configuration in VSCode/Android Studio or use the following commands:

```sh
# Development
$ flutter run --flavor development --target lib/main_development.dart

# Staging
$ flutter run --flavor staging --target lib/main_staging.dart

# Production
$ flutter run --flavor production --target lib/main_production.dart
```

_\*Xcards works on iOS, Android, Web, and Windows._

---

## Running Tests ğŸ§ª

This project emphasizes comprehensive testing with high coverage targets:
- Domain layer (use cases, models): 90%+
- Presentation layer (cubits, states): 85%+
- Data layer (services): 80%+
- UI layer (pages, views): 70%+

### Run All Tests

```sh
$ flutter test
```

Or with Very Good CLI:

```sh
$ very_good test --coverage --test-randomize-ordering-seed random
```

### Run Specific Test Suites

```sh
# Run tests for a specific feature
$ flutter test test/features/counter/

# Run tests with coverage
$ flutter test --coverage

# Run specific test file
$ flutter test test/features/counter/presentation/cubit/counter_cubit_test.dart
```

### View Coverage Report

To view the generated coverage report you can use [lcov](https://github.com/linux-test-project/lcov).

```sh
# Generate Coverage Report
$ genhtml coverage/lcov.info -o coverage/

# Open Coverage Report
$ open coverage/index.html
```

### Testing Guidelines

- All tests use **mocktail** for mocking dependencies
- Widget tests use **PumpApp** helper from `test/helpers/pump_app.dart`
- Cubit tests use **blocTest** from bloc_test package
- Pages that use GetIt require mock registration in `setUp()` and cleanup in `tearDown()`
- See `.cursor/rules/testing.mdc` for comprehensive testing patterns

---

## Code Generation ğŸ”¨

This project uses several code generation tools. After creating or modifying certain files, run:

### Generate Freezed, Injectable, Retrofit, Auto Route

```sh
# Full regeneration (recommended after changes)
$ dart run build_runner build --delete-conflicting-outputs

# Watch mode (regenerates on file changes)
$ dart run build_runner watch --delete-conflicting-outputs
```

This generates:
- `.freezed.dart` files for immutable models and states
- `.g.dart` files for JSON serialization
- `.g.dart` files for Retrofit API clients
- `.config.dart` for injectable dependency injection
- `.gr.dart` for auto_route navigation

### Generate Localizations

```sh
$ flutter gen-l10n --arb-dir="lib/l10n/arb"
```

This generates `app_localizations*.dart` files for all supported locales.

**Note**: Run code generation after:
- Creating/modifying freezed classes (models, states, DTOs)
- Adding/changing injectable annotations
- Modifying Retrofit API clients
- Updating auto_route pages
- Changing ARB localization files

---

## Working with Translations ğŸŒ

This project relies on [flutter_localizations][flutter_localizations_link] and follows the [official internationalization guide for Flutter][internationalization_link].

**Supported Languages**: English (en), Polish (pl)

### Adding Strings

1. To add a new localizable string, open the `app_en.arb` file at `lib/l10n/arb/app_en.arb`.

```arb
{
    "@@locale": "en",
    "@@@____COUNTER___START": {},
    "counterAppBarTitle": "Counter",
    "@counterAppBarTitle": {
        "description": "Text shown in the AppBar of the Counter Page"
    },
    "@@@____COUNTER___END": {}
}
```

**Note**: Use section markers (`@@@____FEATURE___START/END`) to organize strings by feature.

2. Then add a new key/value and description

```arb
{
    "@@locale": "en",
    "@@@____COUNTER___START": {},
    "counterAppBarTitle": "Counter",
    "@counterAppBarTitle": {
        "description": "Text shown in the AppBar of the Counter Page"
    },
    "helloWorld": "Hello World",
    "@helloWorld": {
        "description": "Hello World Text"
    },
    "@@@____COUNTER___END": {}
}
```

3. Use the new string

```dart
import 'package:xcards/l10n/l10n.dart';

@override
Widget build(BuildContext context) {
  final l10n = context.l10n;
  return Text(l10n.helloWorld);
}
```

**Important**: Never hardcode user-facing strings - always use `context.l10n`!

### Adding Supported Locales

Update the `CFBundleLocalizations` array in the `Info.plist` at `ios/Runner/Info.plist` to include the new locale.

```xml
    ...

    <key>CFBundleLocalizations</key>
	<array>
		<string>en</string>
		<string>pl</string>
	</array>

    ...
```

### Adding Translations

1. For each supported locale, add a new ARB file in `lib/l10n/arb`.

```
â”œâ”€â”€ l10n
â”‚   â”œâ”€â”€ arb
â”‚   â”‚   â”œâ”€â”€ app_en.arb
â”‚   â”‚   â””â”€â”€ app_pl.arb
```

2. Add the translated strings to each `.arb` file:

`app_en.arb`

```arb
{
    "@@locale": "en",
    "@@@____COUNTER___START": {},
    "counterAppBarTitle": "Counter",
    "@counterAppBarTitle": {
        "description": "Text shown in the AppBar of the Counter Page"
    },
    "@@@____COUNTER___END": {}
}
```

`app_pl.arb`

```arb
{
    "@@locale": "pl",
    "@@@____COUNTER___START": {},
    "counterAppBarTitle": "Licznik",
    "@counterAppBarTitle": {
        "description": "Tekst wyÅ›wietlany w AppBar strony Licznika"
    },
    "@@@____COUNTER___END": {}
}
```

### Generating Translations

To use the latest translations changes, you will need to generate them:

1. Generate localizations for the current project:

```sh
flutter gen-l10n --arb-dir="lib/l10n/arb"
```

Alternatively, run `flutter run` and code generation will take place automatically.

For more details, see `.cursor/rules/l10n.mdc`.

---

## AI Integration ğŸ¤–

This project integrates with **OpenRouter** to leverage various AI models for intelligent flashcard generation.

### Supported AI Models

The application supports multiple AI models through OpenRouter:

| Model | Model ID | Cost | Best For |
|-------|----------|------|----------|
| **DeepSeek R1T2 Chimera** | `tngtech/deepseek-r1t2-chimera:free` | **Free** | **Default - Great for flashcards** |
| GPT-4o Mini | `openai/gpt-4o-mini` | ~$0.15/$0.60 per 1M tokens | Balanced performance |
| Gemini Flash 1.5 | `google/gemini-flash-1.5:free` | Free (with limits) | Alternative free option |
| GPT-4o | `openai/gpt-4o` | ~$2.50/$10 per 1M tokens | Highest quality |
| Claude 3.5 Sonnet | `anthropic/claude-3-5-sonnet` | ~$3/$15 per 1M tokens | Complex reasoning |

**Default Model**: `tngtech/deepseek-r1t2-chimera:free` (**Free**, great quality for flashcards)

### Setup Instructions

#### 1. Get OpenRouter API Key

1. Create an account at [OpenRouter](https://openrouter.ai/)
2. Add credits to your account (recommended: $1-5 for testing)
3. Generate an API key in [Settings â†’ Keys](https://openrouter.ai/settings/keys)
4. **Important**: Set a credit limit to prevent unexpected charges
5. Configure privacy settings at [Settings â†’ Privacy](https://openrouter.ai/settings/privacy)

#### 2. Configure Environment Variables

Create the following environment files in your project root (these files are git-ignored):

**`.env.development`**
```bash
SUPABASE_URL=your_supabase_url_here
SUPABASE_ANON_KEY=your_supabase_anon_key_here
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxxxxxxxxxx
```

**`.env.staging`**
```bash
SUPABASE_URL=your_staging_supabase_url_here
SUPABASE_ANON_KEY=your_staging_supabase_anon_key_here
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxxxxxxxxxx
```

**`.env.production`**
```bash
SUPABASE_URL=your_production_supabase_url_here
SUPABASE_ANON_KEY=your_production_supabase_anon_key_here
OPENROUTER_API_KEY=sk-or-v1-xxxxxxxxxxxxxxxxxxxxx
```

**Tip**: You can use the same OpenRouter API key for all environments, or create separate keys with different credit limits for better cost control.

#### 3. Generate Environment Files

After adding your API keys, regenerate the environment configuration:

```sh
dart run build_runner build --delete-conflicting-outputs
```

This will securely obfuscate your API keys using the `envied` package.

### Usage Examples

#### Generate Flashcards with AI

```dart
// In your Cubit or Use Case
final result = await generateFlashcardsWithAi(
  sourceText: '''
    Flutter is an open-source UI software development kit created by Google.
    It is used to develop cross platform applications for Android, iOS, Linux,
    macOS, Windows, Google Fuchsia, and the web from a single codebase.
  ''',
  targetCount: 10,
  additionalContext: 'Focus on key concepts for beginners',
);

result.fold(
  (failure) => // Handle error
  (flashcards) => // Use generated flashcards
);
```

#### Custom AI Configuration

```dart
// Use a different model (e.g., GPT-4o for higher quality)
final config = AiModelConfig(
  modelId: 'openai/gpt-4o',
  temperature: 0.7,
  maxTokens: 2000,
);

// Or use predefined configurations
final config = AiModelConfig.gpt4oMini; // Paid, fast
final config = AiModelConfig.deepseekChimeraFree; // Free, default
final config = AiModelConfig.geminiFlashFree; // Free alternative

final result = await generateWithAi(
  messages: [
    AiMessage(role: AiMessageRole.system, content: systemPrompt),
    AiMessage(role: AiMessageRole.user, content: userPrompt),
  ],
  config: config,
);
```

### Cost Estimation

For generating flashcards:
- **Input**: ~500-1500 tokens (source text + prompts)
- **Output**: ~300-800 tokens (10 flashcards with JSON structure)
- **Total per generation**: ~1000-2500 tokens

**Estimated costs** (per 100 flashcard generations):
- **DeepSeek Chimera**: **Free** (default model)
- **GPT-4o Mini**: ~$0.01 - $0.03
- **Gemini Flash**: Free (within limits)
- **GPT-4o**: ~$0.30 - $0.75
- **Claude 3.5 Sonnet**: ~$0.40 - $1.00

### Error Handling

The AI integration includes comprehensive error handling for:

- **Rate Limit Exceeded** (`aiRateLimitExceeded`): Retry after cooldown
- **Insufficient Credits** (`aiInsufficientCredits`): Add credits to OpenRouter account
- **Model Unavailable** (`aiModelUnavailable`): Fallback to alternative model
- **Invalid Response** (`aiInvalidResponse`): Malformed JSON or empty response
- **Timeout** (`aiTimeout`): Request took too long (>60s)
- **Network Error** (`network`): Connection issues

All errors are localized and user-friendly (see `lib/l10n/arb/` for translations).

### Architecture

The AI integration follows Clean Architecture principles:

```
lib/features/ai_integration/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ dto/                      # OpenRouter API DTOs
â”‚   â”‚   â”œâ”€â”€ openrouter_request_dto.dart
â”‚   â”‚   â”œâ”€â”€ openrouter_response_dto.dart
â”‚   â”‚   â””â”€â”€ openrouter_message_dto.dart
â”‚   â”œâ”€â”€ data_source/             # Retrofit API client
â”‚   â”‚   â””â”€â”€ openrouter_data_source.dart
â”‚   â””â”€â”€ service/                 # Service implementation
â”‚       â””â”€â”€ openrouter_service.dart
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ model/                   # Domain models
â”‚   â”‚   â”œâ”€â”€ ai_message.dart
â”‚   â”‚   â”œâ”€â”€ ai_response.dart
â”‚   â”‚   â””â”€â”€ ai_model_config.dart
â”‚   â””â”€â”€ usecase/                 # Business logic
â”‚       â””â”€â”€ generate_with_ai_usecase.dart
â””â”€â”€ (presentation)              # Optional UI components
```

**Integration points**:
- `GenerateFlashcardsWithAiUseCase` - Orchestrates flashcard generation
- `GenerationCubit.generateWithAI()` - UI-triggered AI generation
- `OpenRouterService` - Handles API communication and error mapping

### Security Best Practices

âœ… **API keys are obfuscated** using `envied` package  
âœ… **Environment files are git-ignored** (`.env.*` in `.gitignore`)  
âœ… **Request/response logging** available only in development  
âœ… **Timeout limits** prevent hanging requests (30s connect, 60s receive)  
âœ… **Credit limits** should be set in OpenRouter dashboard  

âš ï¸ **Never commit `.env.*` files to version control**  
âš ï¸ **Never log full API keys** (only first/last 4 characters if needed)  
âš ï¸ **Monitor usage** regularly in OpenRouter dashboard  

### Testing

The AI integration includes comprehensive unit tests:

```sh
# Run all AI integration tests
flutter test test/features/ai_integration/

# Run specific test suites
flutter test test/features/ai_integration/data/service/
flutter test test/features/ai_integration/domain/usecase/
```

**Test coverage**: 27 unit tests covering:
- OpenRouterService (DTO conversions, error handling)
- GenerateWithAiUseCase (message handling, config)
- GenerateFlashcardsWithAiUseCase (JSON parsing, validation)

### Troubleshooting

**Issue**: `Missing OPENROUTER_API_KEY environment variable`  
**Solution**: Ensure `.env.*` files exist and run `dart run build_runner build`

**Issue**: `401 Unauthorized`  
**Solution**: Check that your API key is valid and not expired

**Issue**: `402 Insufficient Credits`  
**Solution**: Add credits to your OpenRouter account

**Issue**: `429 Rate Limit Exceeded`  
**Solution**: Wait before retrying or upgrade your OpenRouter plan

**Issue**: `503 Model Unavailable`  
**Solution**: Try a different model or wait for the model to become available

For more details, see the implementation plan: `.ai/openrouter-service-implementation-plan.md`

---

## For Developers & AI Agents ğŸ¤–

### Quick Start for Contributors

1. **Read the Architecture Rules**: All development guidelines are in `.cursor/rules/`
   - Start with `.cursor/rules/README.md` for an overview
   - Reference specific rule files based on what you're working on

2. **Key Principles** (Never violate these):
   - âŒ No magic numbers â†’ âœ… Use `AppDimensions`
   - âŒ No hardcoded strings â†’ âœ… Use `context.l10n`
   - âŒ No throwing exceptions â†’ âœ… Use `AppFailure`
   - âŒ No logic in Views â†’ âœ… Keep it in Cubits/UseCases
   - âŒ No direct instantiation â†’ âœ… Use dependency injection

3. **Before Committing**:
   ```sh
   # Run code generation
   dart run build_runner build --delete-conflicting-outputs
   flutter gen-l10n --arb-dir="lib/l10n/arb"
   
   # Run tests
   flutter test
   
   # Check for issues
   flutter analyze
   ```

### Project Structure Quick Reference

```
lib/
â”œâ”€â”€ app/                  # App config, DI, failures, constants
â”œâ”€â”€ presentation/         # Shared UI (common_widgets, styles, routing)
â””â”€â”€ features/
    â””â”€â”€ {feature}/
        â”œâ”€â”€ data/         # DTOs, services, API clients
        â”œâ”€â”€ domain/       # Models, use cases (business logic)
        â””â”€â”€ presentation/ # Cubits, pages, views, widgets

test/
â”œâ”€â”€ features/            # Mirrors lib/features structure
â””â”€â”€ helpers/             # Test utilities (pump_app, etc.)
```

### Common Commands

```sh
# Run with specific flavor
flutter run --flavor development --target lib/main_development.dart

# Generate code (freezed, injectable, retrofit, routes)
dart run build_runner build --delete-conflicting-outputs

# Generate localizations
flutter gen-l10n --arb-dir="lib/l10n/arb"

# Run tests with coverage
flutter test --coverage

# Analyze code
flutter analyze

# Format code
dart format .
```

### Resources

- **Project Rules**: `.cursor/rules/README.md`
- **Testing Guide**: `.cursor/rules/testing.mdc`
- **Clean Architecture**: Domain â†’ Data â†’ Presentation
- **10xDevs Certification**: [https://www.10xdevs.pl/](https://www.10xdevs.pl/)

---

[coverage_badge]: coverage_badge.svg
[flutter_localizations_link]: https://api.flutter.dev/flutter/flutter_localizations/flutter_localizations-library.html
[internationalization_link]: https://flutter.dev/docs/development/accessibility-and-localization/internationalization
[license_badge]: https://img.shields.io/badge/license-MIT-blue.svg
[license_link]: https://opensource.org/licenses/MIT
[very_good_analysis_badge]: https://img.shields.io/badge/style-very_good_analysis-B22C89.svg
[very_good_analysis_link]: https://pub.dev/packages/very_good_analysis
[very_good_cli_link]: https://github.com/VeryGoodOpenSource/very_good_cli
